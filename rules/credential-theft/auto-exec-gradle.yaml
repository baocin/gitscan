rules:
  - id: gradle-init-script-present
    message: Gradle init script detected - executes before every Gradle build
    severity: WARNING
    metadata:
      category: info-leak
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      owasp: "A06:2021 - Vulnerable and Outdated Components"
      confidence: MEDIUM
      references:
        - "https://docs.gradle.org/current/userguide/init_scripts.html"
    languages: [generic]
    paths:
      include:
        - "gradle/init.gradle"
        - "gradle/init.gradle.kts"
        - "init.gradle"
        - "init.gradle.kts"
    patterns:
      - pattern-regex: '.*'  # Any init script is suspicious

  - id: gradle-exec-task
    message: Gradle build script executes shell commands - runs during gradle build
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-78: OS Command Injection"
      owasp: "A03:2021 - Injection"
      confidence: HIGH
    languages: [generic]
    paths:
      include:
        - "build.gradle"
        - "build.gradle.kts"
        - "*/build.gradle"
        - "*/build.gradle.kts"
    patterns:
      - pattern-either:
          # Groovy exec
          - pattern-regex: 'exec\s*\{'
          - pattern-regex: "exec\\s*\\{"

          # Kotlin exec
          - pattern-regex: 'exec\s*\(\s*\{'

          # Process execution
          - pattern-regex: '(Runtime|ProcessBuilder).*exec'
          - pattern-regex: '""".*curl.*"""\.execute\(\)'
          - pattern-regex: '".*wget.*"\.execute\(\)'

  - id: gradle-network-download
    message: Gradle build script downloads from network - executes during build
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-494: Download of Code Without Integrity Check"
      owasp: "A08:2021 - Software and Data Integrity Failures"
      confidence: HIGH
    languages: [generic]
    paths:
      include:
        - "build.gradle"
        - "build.gradle.kts"
    patterns:
      - pattern-either:
          # URL downloads
          - pattern-regex: "URL\\([\"']http"
          - pattern-regex: "new URL\\("
          - pattern-regex: "\\.toURL\\(\\)\\.openStream\\(\\)"

          # HTTP clients
          - pattern-regex: 'HttpClient'
          - pattern-regex: 'HttpURLConnection'

  - id: gradle-buildscript-untrusted-repo
    message: Gradle uses non-standard repository in buildscript - verify repository trust
    severity: WARNING
    metadata:
      category: info-leak
      cwe: "CWE-829: Inclusion of Functionality from Untrusted Control Sphere"
      owasp: "A06:2021 - Vulnerable and Outdated Components"
      confidence: MEDIUM
    languages: [generic]
    paths:
      include:
        - "build.gradle"
        - "build.gradle.kts"
    patterns:
      - pattern-either:
          # Maven repository with custom URL
          - pattern-regex: "maven\\s*\\{[\\s\\S]{1,200}?url\\s+[\"'](?!https://(repo\\.maven\\.apache\\.org|repo1\\.maven\\.org|jcenter\\.bintray\\.com))"

          # Custom repository URLs
          - pattern-regex: "repositories\\s*\\{[\\s\\S]{1,300}?url\\s*=?\\s*[\"']http[^\"']*[\"']"

  - id: gradle-credential-access
    message: Gradle build script accesses credential files - review before building
    severity: WARNING
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: LOW
    languages: [generic]
    paths:
      include:
        - "build.gradle"
        - "build.gradle.kts"
    patterns:
      - pattern-either:
          # File access to credentials
          - pattern-regex: "File\\([\"'].*\\.aws/credentials"
          - pattern-regex: "File\\([\"'].*\\.ssh/id_rsa"
          - pattern-regex: "new File\\(.*\\.aws"
