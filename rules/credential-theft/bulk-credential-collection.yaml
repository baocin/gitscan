rules:
  - id: bulk-ssh-key-collection-js
    message: Bulk collection of SSH keys - potential credential harvesting
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # Reading .ssh directory recursively
          - pattern: |
              fs.readdirSync("=~/.ssh/")
              ...
              fs.readFileSync(...)
          - pattern: |
              $FILES = fs.readdirSync("=~/.ssh/")
              ...
              $FILES.forEach($FILE => {
                  ...
                  fs.readFileSync(...)
              })

          # Multiple SSH key reads in sequence
          - pattern: |
              fs.readFileSync("=~/.ssh/id_rsa/")
              ...
              fs.readFileSync("=~/.ssh/id_dsa/")
          - pattern: |
              fs.readFileSync("=~/.ssh/id_rsa/")
              ...
              fs.readFileSync("=~/.ssh/id_ecdsa/")

  - id: bulk-ssh-key-collection-python
    message: Bulk collection of SSH keys - potential credential harvesting
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          # Reading .ssh directory recursively
          - pattern: |
              for $FILE in os.listdir(os.path.expanduser("~/.ssh")):
                  ...
                  open(...)
          - pattern: |
              for $FILE in Path.home().joinpath(".ssh").iterdir():
                  ...
                  open(...)

          # Multiple SSH key reads
          - pattern: |
              open(os.path.expanduser("~/.ssh/id_rsa"))
              ...
              open(os.path.expanduser("~/.ssh/id_dsa"))
          - pattern: |
              open(os.path.expanduser("~/.ssh/id_rsa"))
              ...
              open(os.path.expanduser("~/.ssh/id_ecdsa"))

  - id: sequential-credential-file-access-js
    message: Sequential access to multiple credential files - potential credential harvesting
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # AWS + SSH combination
          - pattern: |
              fs.readFileSync("=~/.aws/credentials/")
              ...
              fs.readFileSync("=~/.ssh/id_rsa/")

          # SSH + npmrc combination
          - pattern: |
              fs.readFileSync("=~/.ssh/id_rsa/")
              ...
              fs.readFileSync("=~/.npmrc/")

          # Multiple credential stores
          - pattern: |
              fs.readFileSync("=~/.aws/credentials/")
              ...
              fs.readFileSync("=~/.npmrc/")

          # Credentials + Docker config
          - pattern: |
              fs.readFileSync("=~/.aws/credentials/")
              ...
              fs.readFileSync("=~/.docker/config.json/")

  - id: sequential-credential-file-access-python
    message: Sequential access to multiple credential files - potential credential harvesting
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    languages: [python]
    patterns:
      - pattern-either:
          # AWS + SSH combination
          - pattern: |
              open(os.path.expanduser("~/.aws/credentials"))
              ...
              open(os.path.expanduser("~/.ssh/id_rsa"))

          # SSH + npmrc combination
          - pattern: |
              open(os.path.expanduser("~/.ssh/id_rsa"))
              ...
              open(os.path.expanduser("~/.npmrc"))

          # Multiple credential stores
          - pattern: |
              open(os.path.expanduser("~/.aws/credentials"))
              ...
              open(os.path.expanduser("~/.npmrc"))

  - id: home-directory-recursive-search-js
    message: Recursive search of home directory - potential bulk credential collection
    severity: WARNING
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: LOW
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # Recursive directory read from home
          - pattern: |
              $WALK = require('walk')
              ...
              $WALK.walk(os.homedir(), ...)

          # Glob all files in home
          - pattern: |
              glob(os.homedir() + "/**/*", ...)

  - id: home-directory-recursive-search-python
    message: Recursive search of home directory - potential bulk credential collection
    severity: WARNING
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: LOW
    languages: [python]
    patterns:
      - pattern-either:
          # os.walk from home directory
          - pattern: |
              for $ROOT, $DIRS, $FILES in os.walk(os.path.expanduser("~")):
                  ...
          - pattern: |
              for $ROOT, $DIRS, $FILES in os.walk(str(Path.home())):
                  ...

          # Recursive glob from home
          - pattern: |
              Path.home().rglob("*")

  - id: archive-credential-directories-js
    message: Creating archive of credential directories - potential bulk exfiltration
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # Archiving .ssh directory
          - pattern: |
              archiver(...)
              ...
              $ARCHIVE.directory("=~/.ssh/", ...)

          # tar-fs or similar
          - pattern: |
              tar.pack("=~/.ssh/")

  - id: archive-credential-directories-python
    message: Creating archive of credential directories - potential bulk exfiltration
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          # tarfile on .ssh
          - pattern: |
              tarfile.open(...)
              ...
              $TAR.add(os.path.expanduser("~/.ssh"), ...)

          # zipfile on credentials
          - pattern: |
              zipfile.ZipFile(...)
              ...
              $ZIP.write(os.path.expanduser("~/.ssh/..."), ...)

          # shutil.make_archive on sensitive dirs
          - pattern: |
              shutil.make_archive(..., root_dir=os.path.expanduser("~/.ssh"))
          - pattern: |
              shutil.make_archive(..., root_dir=os.path.expanduser("~/.aws"))

  - id: batch-env-and-file-credential-theft-js
    message: Collecting both environment variables and credential files - comprehensive credential theft
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # Process.env dump + file reads
          - pattern: |
              $ENV = process.env
              ...
              fs.readFileSync("=~/.ssh/")
          - pattern: |
              Object.keys(process.env)
              ...
              fs.readFileSync("=~/.aws/")

  - id: batch-env-and-file-credential-theft-python
    message: Collecting both environment variables and credential files - comprehensive credential theft
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [python]
    patterns:
      - pattern-either:
          # os.environ dump + file reads
          - pattern: |
              dict(os.environ)
              ...
              open(os.path.expanduser("~/.ssh/id_rsa"))
          - pattern: |
              os.environ.items()
              ...
              open(os.path.expanduser("~/.aws/credentials"))

  - id: loop-read-multiple-credential-types-js
    message: Loop reading multiple types of credentials - potential harvesting attack
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    languages: [javascript, typescript]
    patterns:
      - pattern-either:
          # Array of credential paths
          - pattern: |
              $PATHS = ["=~/.ssh/", "=~/.aws/", ...]
              ...
              $PATHS.forEach($P => fs.readFileSync($P))
          - pattern: |
              for ($PATH of [...]) {
                  ...
                  fs.readFileSync($PATH)
              }

  - id: loop-read-multiple-credential-types-python
    message: Loop reading multiple types of credentials - potential harvesting attack
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    languages: [python]
    patterns:
      - pattern-either:
          # List of credential paths
          - pattern: |
              for $PATH in [...]:
                  ...
                  open(os.path.expanduser($PATH))
          - pattern: |
              $PATHS = [...]
              ...
              for $PATH in $PATHS:
                  ...
                  open($PATH)
