rules:
  - id: bash-steal-credentials
    message: Shell script accessing sensitive credential files - potential credential theft
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [bash, sh]
    patterns:
      - pattern-either:
          # Reading AWS credentials
          - pattern: cat "$HOME/.aws/credentials"
          - pattern: cat ~/.aws/credentials
          - pattern: cat $HOME/.aws/credentials
          - pattern: cat "$HOME/.aws/config"
          - pattern: cat ~/.aws/config

          # Reading SSH private keys
          - pattern: cat "$HOME/.ssh/id_rsa"
          - pattern: cat ~/.ssh/id_rsa
          - pattern: cat $HOME/.ssh/id_rsa
          - pattern: cat "$HOME/.ssh/id_dsa"
          - pattern: cat ~/.ssh/id_dsa
          - pattern: cat "$HOME/.ssh/id_ecdsa"
          - pattern: cat ~/.ssh/id_ecdsa
          - pattern: cat "$HOME/.ssh/id_ed25519"
          - pattern: cat ~/.ssh/id_ed25519

          # Reading SSH config files
          - pattern: cat "$HOME/.ssh/config"
          - pattern: cat ~/.ssh/config
          - pattern: cat "$HOME/.ssh/known_hosts"
          - pattern: cat ~/.ssh/known_hosts
          - pattern: cat "$HOME/.ssh/authorized_keys"
          - pattern: cat ~/.ssh/authorized_keys

          # Looping through SSH keys
          - pattern: |
              for $KEY in ~/.ssh/id_*; do
                  ...
                  cat "$KEY"
                  ...
              done

          # Dumping environment variables
          - pattern: env
          - pattern: printenv

          # Searching for .env files
          - pattern: find ... -name ".env*"
          - pattern: find ... -name ".env"

          # Reading .env files
          - pattern: cat .env
          - pattern: cat .env.local
          - pattern: cat .env.production
          - pattern: cat .env.development
          - pattern: cat "$PWD/.env"

          # Grep for AWS/credentials in environment
          - pattern: env | grep -i AWS
          - pattern: env | grep -i SECRET
          - pattern: env | grep -i TOKEN
          - pattern: env | grep -i PASSWORD
          - pattern: env | grep -i KEY

          # Searching common credential locations with loops
          - pattern: |
              for $FILE in ~/.aws/*; do
                  ...
                  cat "$FILE"
                  ...
              done

          - pattern: |
              for $FILE in ~/.config/aws/*; do
                  ...
                  cat "$FILE"
                  ...
              done

          # Reading .npmrc
          - pattern: cat "$HOME/.npmrc"
          - pattern: cat ~/.npmrc
          - pattern: cat $HOME/.npmrc

          # curl POST with credential files
          - pattern: curl ... -d @"$HOME/.aws/credentials"
          - pattern: curl ... -d @"$HOME/.ssh/id_rsa"
          - pattern: curl ... -d @"$HOME/.npmrc"

          # Piping env to curl (exfiltration)
          - pattern: env | curl ...
          - pattern: printenv | curl ...
