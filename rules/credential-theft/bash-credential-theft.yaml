rules:
  - id: bash-steal-credentials
    message: Shell script accessing sensitive credential files - potential credential theft
    severity: ERROR
    metadata:
      category: info-leak
      cwe: "CWE-522: Insufficiently Protected Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    languages: [bash, sh]
    patterns:
      - pattern-either:
          # Reading AWS credentials
          - pattern: cat "$HOME/.aws/credentials"
          - pattern: cat ~/.aws/credentials
          - pattern: cat $HOME/.aws/credentials
          - pattern: cat "$HOME/.aws/config"
          - pattern: cat ~/.aws/config

          # Reading SSH private keys
          - pattern: cat "$HOME/.ssh/id_rsa"
          - pattern: cat ~/.ssh/id_rsa
          - pattern: cat $HOME/.ssh/id_rsa
          - pattern: cat "$HOME/.ssh/id_dsa"
          - pattern: cat ~/.ssh/id_dsa
          - pattern: cat "$HOME/.ssh/id_ecdsa"
          - pattern: cat ~/.ssh/id_ecdsa
          - pattern: cat "$HOME/.ssh/id_ed25519"
          - pattern: cat ~/.ssh/id_ed25519

          # Reading SSH config files
          - pattern: cat "$HOME/.ssh/config"
          - pattern: cat ~/.ssh/config
          - pattern: cat "$HOME/.ssh/known_hosts"
          - pattern: cat ~/.ssh/known_hosts
          - pattern: cat "$HOME/.ssh/authorized_keys"
          - pattern: cat ~/.ssh/authorized_keys

          # Looping through SSH keys
          - pattern: |
              for $KEY in ~/.ssh/id_*; do
                  ...
                  cat "$KEY"
                  ...
              done

          # Dumping environment variables
          - pattern: env
          - pattern: printenv

          # Searching for .env files
          - pattern: find ... -name ".env*"
          - pattern: find ... -name ".env"

          # Reading .env files
          - pattern: cat .env
          - pattern: cat .env.local
          - pattern: cat .env.production
          - pattern: cat .env.development
          - pattern: cat "$PWD/.env"

          # Grep for AWS/credentials in environment
          - pattern: env | grep -i AWS
          - pattern: env | grep -i SECRET
          - pattern: env | grep -i TOKEN
          - pattern: env | grep -i PASSWORD
          - pattern: env | grep -i KEY

          # Searching common credential locations with loops
          - pattern: |
              for $FILE in ~/.aws/*; do
                  ...
                  cat "$FILE"
                  ...
              done

          - pattern: |
              for $FILE in ~/.config/aws/*; do
                  ...
                  cat "$FILE"
                  ...
              done

          # Reading .npmrc
          - pattern: cat "$HOME/.npmrc"
          - pattern: cat ~/.npmrc
          - pattern: cat $HOME/.npmrc

          # curl POST with credential files
          - pattern: curl ... -d @"$HOME/.aws/credentials"
          - pattern: curl ... -d @"$HOME/.ssh/id_rsa"
          - pattern: curl ... -d @"$HOME/.npmrc"

          # Piping env to curl (exfiltration)
          - pattern: env | curl ...
          - pattern: printenv | curl ...

          # Alternative commands to read credentials (head, tail, less, more, etc.)
          - pattern: head "$HOME/.ssh/id_rsa"
          - pattern: head ~/.ssh/id_rsa
          - pattern: head "$HOME/.aws/credentials"
          - pattern: head ~/.aws/credentials

          - pattern: tail "$HOME/.ssh/id_rsa"
          - pattern: tail ~/.ssh/id_rsa
          - pattern: tail "$HOME/.aws/credentials"
          - pattern: tail ~/.aws/credentials

          - pattern: less "$HOME/.ssh/id_rsa"
          - pattern: less ~/.ssh/id_rsa
          - pattern: less "$HOME/.aws/credentials"
          - pattern: less ~/.aws/credentials

          - pattern: more "$HOME/.ssh/id_rsa"
          - pattern: more ~/.ssh/id_rsa
          - pattern: more "$HOME/.aws/credentials"
          - pattern: more ~/.aws/credentials

          - pattern: strings "$HOME/.ssh/id_rsa"
          - pattern: strings ~/.ssh/id_rsa

          # dd command to copy credential files
          - pattern: dd if="$HOME/.ssh/id_rsa"
          - pattern: dd if=~/.ssh/id_rsa
          - pattern: dd if=$HOME/.ssh/id_rsa
          - pattern: dd if="$HOME/.aws/credentials"
          - pattern: dd if=~/.aws/credentials

          # Archive operations on credential directories
          - pattern: tar ... ~/.ssh ...
          - pattern: tar ... "$HOME/.ssh" ...
          - pattern: tar ... $HOME/.ssh ...
          - pattern: tar ... ~/.aws ...
          - pattern: tar ... "$HOME/.aws" ...

          - pattern: zip ... ~/.ssh ...
          - pattern: zip ... "$HOME/.ssh" ...
          - pattern: zip ... ~/.aws ...
          - pattern: zip ... "$HOME/.aws" ...

          - pattern: tar -czf ... ~/.ssh
          - pattern: tar -czf ... ~/.aws
          - pattern: zip -r ... ~/.ssh
          - pattern: zip -r ... ~/.aws

          # Shell redirection reading credentials
          - pattern: <"$HOME/.ssh/id_rsa"
          - pattern: <~/.ssh/id_rsa
          - pattern: <$HOME/.ssh/id_rsa
          - pattern: <"$HOME/.aws/credentials"
          - pattern: <~/.aws/credentials

          # Process substitution
          - pattern: echo "$(<~/.ssh/id_rsa)"
          - pattern: echo "$(<~/.aws/credentials)"
          - pattern: echo "$(<$HOME/.ssh/id_rsa)"

          # Base64 encoding credential files for exfiltration
          - pattern: base64 "$HOME/.ssh/id_rsa"
          - pattern: base64 ~/.ssh/id_rsa
          - pattern: base64 "$HOME/.aws/credentials"
          - pattern: base64 ~/.aws/credentials
          - pattern: cat ~/.ssh/id_rsa | base64
          - pattern: cat "$HOME/.ssh/id_rsa" | base64
          - pattern: cat ~/.aws/credentials | base64

          # Copying credential files to temp/other locations
          - pattern: cp "$HOME/.ssh/id_rsa" ...
          - pattern: cp ~/.ssh/id_rsa ...
          - pattern: cp $HOME/.ssh/id_rsa ...
          - pattern: cp "$HOME/.aws/credentials" ...
          - pattern: cp ~/.aws/credentials ...

          # Using grep/awk/sed to extract from credential files
          - pattern: grep ... "$HOME/.ssh/id_rsa"
          - pattern: grep ... ~/.ssh/id_rsa
          - pattern: grep ... "$HOME/.aws/credentials"
          - pattern: grep ... ~/.aws/credentials
          - pattern: awk ... "$HOME/.ssh/id_rsa"
          - pattern: awk ... ~/.ssh/id_rsa
          - pattern: sed ... "$HOME/.ssh/id_rsa"
          - pattern: sed ... ~/.ssh/id_rsa

          # Reading .gitconfig for credentials
          - pattern: cat "$HOME/.gitconfig"
          - pattern: cat ~/.gitconfig
          - pattern: cat $HOME/.gitconfig

          # Reading .git-credentials
          - pattern: cat "$HOME/.git-credentials"
          - pattern: cat ~/.git-credentials
          - pattern: cat $HOME/.git-credentials

          # Reading GPG keys
          - pattern: cat "$HOME/.gnupg/secring.gpg"
          - pattern: cat ~/.gnupg/secring.gpg
          - pattern: cat "$HOME/.gnupg/pubring.gpg"
          - pattern: cat ~/.gnupg/pubring.gpg

          # Searching home directory for private keys
          - pattern: find "$HOME" -name "id_rsa"
          - pattern: find ~ -name "id_rsa"
          - pattern: find "$HOME" -name "id_dsa"
          - pattern: find "$HOME" -name "id_ecdsa"
          - pattern: find "$HOME" -name "id_ed25519"
          - pattern: find "$HOME" -name "*_rsa"
          - pattern: find "$HOME" -name "*.pem"
          - pattern: find "$HOME" -name "credentials"
          - pattern: find "$HOME" -name "*.key"

          # Bulk operations on SSH directory
          - pattern: tar ... ~/.ssh | ...
          - pattern: zip ... ~/.ssh | ...
          - pattern: tar ... ~/.ssh > ...
          - pattern: zip ... ~/.ssh > ...
